// Global KiddoVerse namespace
var KV = KV || {}; 
KV.Themes = { DEFAULT:{name:"Default",skyColor:new THREE.Color(0x87CEEB),fogNearFactor:1.5,fogFarFactor:0.75,ambientLightIntensity:1.2,directionalLightIntensity:2.5,terrainParams:{noiseScaleXZ:0.025,baseHeight:KV.BLOCK_SIZE*16*1.2,amplitude:KV.BLOCK_SIZE*16*0.9,stoneDepth:5,blockPalette:{surface:KV.BLOCK_TYPES.GRASS,subSurface:KV.BLOCK_TYPES.DIRT,deepStone:KV.BLOCK_TYPES.STONE,}}}, SPACE:{name:"Space",skyColor:new THREE.Color(0x050515),fogNearFactor:2.5,fogFarFactor:0.85,ambientLightIntensity:0.4,directionalLightIntensity:1.8,terrainParams:{noiseScaleXZ:0.035,baseHeight:KV.BLOCK_SIZE*16*0.8,amplitude:KV.BLOCK_SIZE*16*0.5,stoneDepth:8,blockPalette:{surface:KV.BLOCK_TYPES.MOON_ROCK,subSurface:KV.BLOCK_TYPES.MOON_ROCK,deepStone:KV.BLOCK_TYPES.METAL_PANEL,}}} };
class KiddoVerseGame { constructor(){if(typeof THREE==='undefined'){console.error("THREE.js not loaded.");alert("CRITICAL ERROR: THREE.js not found.");if(document.getElementById('loading-screen'))document.getElementById('loading-text').textContent="Error: THREE.js missing.";return;}this.scene=new THREE.Scene();this.camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,0.1,2500);this.renderer=new THREE.WebGLRenderer({canvas:document.getElementById('game-canvas'),antialias:true});this.renderer.setPixelRatio(window.devicePixelRatio);this.renderer.setSize(window.innerWidth,window.innerHeight);this.renderer.outputColorSpace=THREE.SRGBColorSpace;this.renderer.toneMapping=THREE.ACESFilmicToneMapping;this.renderer.toneMappingExposure=0.9;this.loadingScreen=document.getElementById('loading-screen');this.progressBar=document.getElementById('progress-bar');this.clock=new THREE.Clock();this.world=null;this.player=null;this.controls=null;this.ui=null;this.audioManager=null;this.currentThemeName=localStorage.getItem('kiddoVerseTheme')||'DEFAULT';this.currentTheme=KV.Themes[this.currentThemeName]||KV.Themes.DEFAULT;console.log("KiddoVerse: Initializing with theme - "+this.currentTheme.name);this.renderer.setClearColor(this.currentTheme.skyColor);this.scene.background=this.currentTheme.skyColor;this.scene.environment=this.scene.background;this.currentBlockType=KV.BLOCK_TYPES.PLASTIC_RED;} applyThemeSettings(theme){this.scene.background=theme.skyColor;this.renderer.setClearColor(theme.skyColor);this.scene.environment=this.scene.background;if(this.scene.fog){this.scene.fog.color.copy(theme.skyColor);this.scene.fog.near=KV.BLOCK_SIZE*(KV.World.prototype.chunkSize||16)*theme.fogNearFactor;this.scene.fog.far=this.camera.far*theme.fogFarFactor;}else{this.scene.fog=new THREE.Fog(theme.skyColor,KV.BLOCK_SIZE*(KV.World.prototype.chunkSize||16)*theme.fogNearFactor,this.camera.far*theme.fogFarFactor);}const hemiLight=this.scene.getObjectByName("hemisphereLight");if(hemiLight)hemiLight.intensity=theme.ambientLightIntensity;const dirLight=this.scene.getObjectByName("directionalLight");if(dirLight)dirLight.intensity=theme.directionalLightIntensity;} async startGame(){if(typeof THREE==='undefined')return;this.updateProgress(10);this.applyThemeSettings(this.currentTheme);const hemiLight=new THREE.HemisphereLight(0xB1E1FF,0xB97A20,this.currentTheme.ambientLightIntensity);hemiLight.name="hemisphereLight";this.scene.add(hemiLight);const dirLight=new THREE.DirectionalLight(0xffffff,this.currentTheme.directionalLightIntensity);dirLight.name="directionalLight";dirLight.position.set(80,120,60);dirLight.castShadow=true;dirLight.shadow.mapSize.width=2048;dirLight.shadow.mapSize.height=2048;dirLight.shadow.camera.near=10;dirLight.shadow.camera.far=300;const sCamSize=KV.BLOCK_SIZE*(KV.World.prototype.chunkSize||16)*2.5;dirLight.shadow.camera.left=-sCamSize;dirLight.shadow.camera.right=sCamSize;dirLight.shadow.camera.top=sCamSize;dirLight.shadow.camera.bottom=-sCamSize;dirLight.shadow.bias=-0.0005;this.scene.add(dirLight);this.scene.add(dirLight.target);dirLight.target.position.set(0,0,0);this.renderer.shadowMap.enabled=true;this.renderer.shadowMap.type=THREE.PCFSoftShadowMap;this.updateProgress(20);this.audioManager=new KV.AudioManager(this.camera);this.audioManager.setScene(this.scene);this.updateProgress(30);this.world=new KV.World(this.scene,KV.BLOCK_SIZE,this.currentTheme);this.updateProgress(40);this.player=new KV.Player(this.scene,this.camera,this.world,this.audioManager);await this.world.generateInitialChunks(this.player.position);this.updateProgress(80);this.controls=new KV.Controls(this.camera,this.renderer.domElement,this.player,this.world,this,this.audioManager);this.updateProgress(90);this.ui=new KV.UI(this);this.updateProgress(95);window.addEventListener('resize',this.onWindowResize.bind(this),false);if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js').then(reg=>console.log('KV SW registered.',reg)).catch(err=>console.error('KV SW reg failed:',err));}this.updateProgress(100);setTimeout(()=>{if(this.loadingScreen)this.loadingScreen.style.display='none';},300);this.animate();} changeTheme(themeName){if(KV.Themes[themeName]&&this.currentThemeName!==themeName){console.log(`KiddoVerse: Changing theme to ${themeName}`);localStorage.setItem('kiddoVerseTheme',themeName);window.location.reload();}else if(!KV.Themes[themeName]){console.warn(`KiddoVerse: Theme "${themeName}" not found.`);}} updateProgress(perc){if(this.progressBar)this.progressBar.style.width=perc+'%';} setCurrentBlockType(bID){this.currentBlockType=bID;} onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight;this.camera.updateProjectionMatrix();this.renderer.setSize(window.innerWidth,window.innerHeight);this.applyThemeSettings(this.currentTheme);} animate(){requestAnimationFrame(this.animate.bind(this));const dT=Math.min(this.clock.getDelta(),0.1);if(this.controls)this.controls.update(dT);if(this.player)this.player.update(dT);if(this.world&&this.player)this.world.update(this.player.position);this.renderer.render(this.scene,this.camera);}}
let kiddoVerseGameInstance; window.addEventListener('DOMContentLoaded',()=>{const ldTxt=document.getElementById('loading-text');const prgBarCont=document.getElementById('progress-bar-container');if(window.location.protocol==='file:'){if(ldTxt)ldTxt.innerHTML="KV: Game may not function optimally from file system.<br>Recommend local web server.";}if(typeof THREE==='undefined'){if(ldTxt)ldTxt.textContent='Error: THREE.js library not found.';if(prgBarCont)prgBarCont.style.display='none';return;}kiddoVerseGameInstance=new KiddoVerseGame();if(kiddoVerseGameInstance&&typeof kiddoVerseGameInstance.startGame==='function'){if(typeof KV!=='undefined'&&KV.World&&KV.Player&&KV.Controls&&KV.UI&&KV.AudioManager&&KV.Noise&&KV.BLOCK_DEFINITIONS&&KV.isTouchDevice){kiddoVerseGameInstance.startGame();}else{console.error("KV: Core components missing.");if(ldTxt)ldTxt.textContent='Error: Core game components missing.';if(prgBarCont)prgBarCont.style.display='none';}}else{if(ldTxt&&typeof THREE!=='undefined'){ldTxt.textContent='Error: Game initialization failed.';}if(prgBarCont)prgBarCont.style.display='none';}});
console.log("KiddoVerse Themes: Main game script updated for themes.");
